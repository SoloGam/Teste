document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".grid"),t=document.getElementById("score"),o=document.getElementById("game-over"),n=4;let r=[],a=0;function d(){for(let t=0;t<n*n;t++){const t=document.createElement("div");t.className="cell",t.innerHTML="",e.appendChild(t),r.push(t)}l(),l(),c()}function l(){let t=r.filter(e=>""===e.innerHTML);if(t.length>0){let e=t[Math.floor(Math.random()*t.length)];e.innerHTML=Math.random()<.9?"2":"4"}u()}function c(){r.forEach(e=>{const t=parseInt(e.innerHTML);e.setAttribute("data-value",t||"0"),t||(e.innerHTML="")})}function s(s){let i=!1,u=[],g=[];for(let e=0;e<n;e++){u.push(r.slice(e*n,e*n+n));let t=[];for(let o=0;o<n;o++)t.push(r[e+o*n]);g.push(t)}let h="ArrowLeft"===s||"ArrowRight"===s?u:g,f="ArrowRight"===s||"ArrowDown"===s,p=h.map(e=>{let t=function(e,t){let o=e.map(e=>({value:parseInt(e.innerHTML)||0}));t&&o.reverse();let r=o.filter(e=>0!==e.value);for(let e=0;e<r.length-1;e++)r[e].value===r[e+1].value&&(r[e].value*=2,a+=r[e].value,score.innerHTML=a,r.splice(e+1,1));for(;r.length<n;)r.push({value:0});t&&r.reverse();return e.map((e,t)=>(e.innerHTML=r[t].value>0?r[t].value.toString():"",e))}(e,f);return JSON.stringify(e.map(e=>e.innerHTML))!==JSON.stringify(t.map(e=>e.innerHTML))&&(i=!0),t});"ArrowLeft"===s||"ArrowRight"===s?r=p.flat():(()=>{for(let e=0;e<n;e++)for(let t=0;t<n;t++)r[t*n+e]=p[e][t]})(),e.innerHTML="",r.forEach(t=>e.appendChild(t)),i&&l(),c()}function u(){if(0===r.filter(e=>""===e.innerHTML).length){for(let e=0;e<n*n;e++){let t=Math.floor(e/n),a=e%n,d=parseInt(r[e].innerHTML);if(a<n-1&&parseInt(r[e+1].innerHTML)===d)return;if(t<n-1&&parseInt(r[e+n].innerHTML)===d)return}o.style.display="flex"}}document.addEventListener("keyup",e=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&s(e.key)});let i=null,g=null;e.addEventListener("touchstart",e=>{i=e.touches[0].clientX,g=e.touches[0].clientY},!1),e.addEventListener("touchmove",e=>{if(!i||!g)return;let t=e.touches[0].clientX,o=e.touches[0].clientY,r=i-t,a=g-o;Math.abs(r)>Math.abs(a)?r>0?s("ArrowLeft"):s("ArrowRight"):a>0?s("ArrowUp"):s("ArrowDown"),i=null,g=null},!1),window.restartGame=function(){a=0,t.innerHTML=a,r.forEach(e=>e.innerHTML=""),o.style.display="none",l(),l(),c()},d()});
